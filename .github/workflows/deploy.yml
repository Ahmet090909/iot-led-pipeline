name: Build, extract binary and deploy to Raspberry Pi

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # image tag uses commit sha so every run is unique (prevents stale cache)
  IMAGE_TAG: fast090909/iot-led-pipeline:${{ github.sha }}
  CONTAINER_NAME: build-temp-container
  BINARY_NAME: mybinary
  BINARY_PATH_IN_IMAGE: /app/mybinary
  REMOTE_DEST_PATH: /home/${{ secrets.PI_USER }}/mybinary
  TMUX_SESSION: app-session

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up QEMU (for emulation)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build ARM image and load into runner (single-platform, no-cache)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          no-cache: true
          platforms: linux/arm64
          tags: ${{ env.IMAGE_TAG }}
          build-args: |
            CACHEBUST=${{ github.run_id }}

      - name: Create container from image
        run: |
          # create container from the built image (use explicit tag)
          if ! docker image inspect "${{ env.IMAGE_TAG }}" >/dev/null 2>&1; then
            # fallback: pick the most recent image id if tag not present
            IMG=$(docker images -q | head -n1)
            docker create --name "${{ env.CONTAINER_NAME }}" "$IMG"
          else
            docker create --name "${{ env.CONTAINER_NAME }}" "${{ env.IMAGE_TAG }}"
          fi

      - name: Copy executable out of container
        run: |
          set -e
          docker cp "${{ env.CONTAINER_NAME }}:${{ env.BINARY_PATH_IN_IMAGE }}" ./${{ env.BINARY_NAME }}
          chmod +x ./${{ env.BINARY_NAME }}
          echo "Copied binary:"
          ls -la ./${{ env.BINARY_NAME }}

      - name: Remove temporary container
        if: always()
        run: docker rm -f "${{ env.CONTAINER_NAME }}" || true

      - name: Prepare SSH private key
        run: |
          echo "${{ secrets.PI_SSH_PRIVATE_KEY }}" > private_key
          chmod 600 private_key

      - name: Add Pi host to known_hosts
        run: |
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.PI_SSH_PORT }}" ]; then
            ssh-keyscan -p "${{ secrets.PI_SSH_PORT }}" -H "${{ secrets.PI_HOST }}" >> ~/.ssh/known_hosts || true
          else
            ssh-keyscan -H "${{ secrets.PI_HOST }}" >> ~/.ssh/known_hosts || true
          fi
          chmod 644 ~/.ssh/known_hosts

      - name: Copy binary to Raspberry Pi
        run: |
         s PORT=${{ ecrets.PI_SSH_PORT || '22' }}
          scp -P "$PORT" -i private_key -o StrictHostKeyChecking=yes ./${{ env.BINARY_NAME }} ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:${{ env.REMOTE_DEST_PATH }}

      - name: Restart binary on Raspberry Pi inside tmux
        run: |
          PORT=${{ secrets.PI_SSH_PORT || '22' }}
          # Expand local vars (REMOTE_DEST_PATH, TMUX_SESSION) locally and run the commands on remote.
          ssh -p "$PORT" -i private_key -o StrictHostKeyChecking=yes ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} \
            "tmux kill-session -t '${{ env.TMUX_SESSION }}' || true && \
             mv '${{ env.REMOTE_DEST_PATH }}' '${{ env.REMOTE_DEST_PATH }}.bak' || true && \
             chmod +x '${{ env.REMOTE_DEST_PATH }}' || true && \
             tmux new -d -s '${{ env.TMUX_SESSION }}' '${{ env.REMOTE_DEST_PATH }}'"