name: Build & Deploy to Raspberry Pi

on:
  push:
    branches: [ "main" ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ Start Tailscale (GitHub → Pi netwerk)
    - name: Setup Tailscale
      uses: tailscale/github-action@v2
      with:
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

    # 3️⃣ Build in Docker (zelfde env als Pi)
    - name: Build Docker image
      run: |
        docker build -t pi-build .

    # 4️⃣ Compile + extract executable
    - name: Compile and extract binary
      run: |
        docker create --name build_container pi-build
        docker cp build_container:/app/led_app ./led_app
        docker rm build_container
        chmod +x led_app

    # 5️⃣ SSH key installeren
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan ${{ secrets.PI_HOST }} >> ~/.ssh/known_hosts

    # 6️⃣ Kopieer executable naar Pi
    - name: Copy binary to Raspberry Pi
      run: |
        scp led_app \
          ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:${{ secrets.PI_APP_DIR }}/led_app.new

    # 7️⃣ Stop oude app & start nieuwe (tmux)
    - name: Restart app on Raspberry Pi
      run: |
        ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} << 'EOF'
        mkdir -p ~/iot
        pkill -f led_app || true
        mv ~/iot/led_app.new ~/iot/led_app
        chmod +x ~/iot/led_app
        tmux kill-session -t led_app || true
        tmux new-session -d -s led_app "~/iot/led_app"
        EOF
